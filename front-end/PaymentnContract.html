<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ma Dental Care - Contract & Payment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
</head>
<body class="bg-gray-50">

  <!-- Navbar -->
<nav class="bg-blue-400 shadow-md">
  <div class="mx-auto flex justify-between items-center px-4 py-4">
    <!-- Title -->
    <h1 class="text-2xl font-bold text-white drop-shadow-lg">
      Smile Dental Care
    </h1>

    <!-- Menu -->
    <ul class="flex space-x-1 text-white font-medium">
      <li><a href="homepage.html" class="hover:text-purple-500">Home</a></li>
      <li><a href="#" class="hover:text-purple-500">Prescriptions</a></li>
      <li><a href="#" class="hover:text-purple-500">View All</a></li>
      <li><a href="listofdrugs.html" class="hover:text-purple-500">Drug Checker</a></li>
      <li><a href="appointment.html" class="hover:text-purple-500">Appointment</a></li>
      <li ><a href="patientSearch.html" class="hover:text-purple-500"></a>Search Patient</li>
 
      <li><a href="PaymentnContract.html" class="hover:text-purple-500">Payment & Contract</a></li>
    </ul>
  </div>
</nav>
<br>
<section id="contract-entry" class="bg-gray-100 flex items-center justify-center min-h-screen my-8">
  <div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-4xl mx-4">
    <h1 class="text-2xl font-bold text-gray-800 text-center mb-6">Contract Entry</h1>

    <!-- Treatments Table -->
    <div class="mt-6">
      <h2 class="text-xl font-bold text-blue-800 mb-4 text-center">ðŸ¦· Treatment Particulars</h2>
      <table class="w-full border border-gray-300 text-sm" id="particulars-table">
        <thead class="bg-gray-200">
          <tr>
            <th class="border p-2">Particular</th>
            <th class="border p-2">Price (à§³)</th>
            <th class="border p-2">Remove</th>
          </tr>
        </thead>
        <tbody>
          <!-- Rows added dynamically -->
        </tbody>
      </table>
    </div>

    <!-- Payment Section -->
    <div class="mt-8 bg-white rounded-lg shadow-md p-6">
      <h2 class="text-xl font-bold text-blue-800 mb-4 text-center">ðŸ’° Payment Entry</h2>

      <div class="flex gap-4 mb-4">
        <div class="w-1/2">
          <label class="block text-sm font-medium text-gray-700">Discount (%)</label>
          <input type="number" id="discount" value="0" class="mt-1 block w-full rounded-md border-gray-300 p-2">
        </div>
        <div class="w-1/2">
          <label class="block text-sm font-medium text-gray-700">Discounted Amount (à§³)</label>
          <input type="number" id="discountedAmount" readonly class="mt-1 block w-full bg-gray-100 rounded-md border-gray-300 p-2">
        </div>
      </div>

      <div class="flex justify-between mb-4">
        <span class="font-medium text-gray-800">Total Bill:</span>
        <span id="totalBill" class="font-semibold text-gray-900">0</span>
      </div>

      <div class="flex justify-between mb-4">
        <label class="font-medium text-gray-800">Paid Today:</label>
        <input type="number" id="paidToday" value="0" class="p-2 border border-gray-300 rounded-md w-40">
      </div>

      <div class="flex justify-between mb-4">
        <span class="font-medium text-gray-800">Total Due:</span>
        <span id="totalDue" class="font-semibold text-gray-900">0</span>
      </div>

      <button id="savePayment" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save Payment</button>
      <button id="makeBill" class="px-4 py-2 bg-green-400 text-white rounded-md hover:bg-blue-700 mt-4">
  Make Bill & Print
</button>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const makeBillBtn = document.getElementById("makeBill");

  makeBillBtn.addEventListener("click", () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    // Header
    doc.setFontSize(16);
    doc.text("Smile Dental Care", 105, 15, { align: "center" });
    doc.setFontSize(12);
    doc.text(`Patient ID: ${patientId}`, 14, 25);
    doc.text(`Date: ${new Date().toLocaleDateString()}`, 150, 25);

    // Treatments Table
    doc.text("ðŸ¦· Treatment Particulars", 105, 35, { align: "center" });
    let startY = 45;
    doc.autoTable({
      startY,
      head: [['Particular', 'Price (à§³)']],
      body: treatments.map(t => [t.treatment, t.price.toFixed(2)]),
      theme: 'grid',
    });

    startY = doc.lastAutoTable.finalY + 10;

    // Payment summary
    doc.text(`Total Bill: à§³${totalBillEl.textContent}`, 14, startY);
    doc.text(`Discount: ${discountEl.value}%`, 14, startY + 8);
    doc.text(`Paid Today: à§³${paidTodayEl.value}`, 14, startY + 16);
    doc.text(`Total Due: à§³${totalDueEl.textContent}`, 14, startY + 24);

    // Save PDF
    doc.save(`Bill_${patientId}.pdf`);

    // Redirect to home
    window.location.href = "homepage.html";
  });
</script>

    </div>
  </div>
</section>

<script>
const tableBody = document.querySelector("#particulars-table tbody");
const discountEl = document.getElementById("discount");
const discountedAmountEl = document.getElementById("discountedAmount");
const totalBillEl = document.getElementById("totalBill");
const totalDueEl = document.getElementById("totalDue");
const paidTodayEl = document.getElementById("paidToday");
const saveBtn = document.getElementById("savePayment");

let treatments = [];
let patientId = localStorage.getItem("patientId") || "21025";

// Fetch patient treatment plan (tp) from backend
async function fetchPatientTreatments() {
  try {
    const res = await fetch(`http://localhost:5000/patients/id/${patientId}`);
    if (!res.ok) throw new Error("Patient not found");
    const patient = await res.json();

    treatments = (patient.tp || []).map(t => ({ treatment: t, price: 0 }));
    renderTreatments();
  } catch (err) {
    console.error(err);
    alert("Failed to fetch treatments for this patient");
  }
}


// Render treatments table
function renderTreatments() {
  tableBody.innerHTML = "";
  treatments.forEach((t, i) => {
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="border px-4 py-2">${t.treatment}</td>
      <td class="border px-4 py-2">
        <input type="number" class="priceInput w-full p-1 border rounded" value="${t.price}">
      </td>
      <td class="border px-4 py-2 text-center">
        <button class="text-red-500 removeBtn"><i class="fa-solid fa-xmark"></i></button>
      </td>
    `;
    tableBody.appendChild(row);

    // Price input listener
    row.querySelector(".priceInput").addEventListener("input", e => {
      t.price = parseFloat(e.target.value) || 0;
      updateBillSummary();
    });

    // Remove button
    row.querySelector(".removeBtn").addEventListener("click", () => {
      treatments.splice(i, 1);
      renderTreatments();
    });
  });
  updateBillSummary();
}

// Update billing summary
function updateBillSummary() {
  const total = treatments.reduce((sum, t) => sum + t.price, 0);
  const discountPercent = parseFloat(discountEl.value) || 0;
  const discountAmount = (total * discountPercent) / 100;
  const discountedTotal = total - discountAmount;

  const paidToday = parseFloat(paidTodayEl.value) || 0;
  const totalDue = discountedTotal - paidToday;

  totalBillEl.textContent = discountedTotal.toFixed(2);
  discountedAmountEl.value = discountedTotal.toFixed(2);
  totalDueEl.textContent = totalDue.toFixed(2);
}

// Listeners
discountEl.addEventListener("input", updateBillSummary);
paidTodayEl.addEventListener("input", updateBillSummary);

// Save payment to backend
saveBtn.addEventListener("click", async () => {
  try {
    const res = await fetch(`/payments/add/${patientId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        treatments: treatments.map(t => t.treatment),
        totalBill: parseFloat(totalBillEl.textContent),
        discount: parseFloat(discountEl.value) || 0,
        paidToday: parseFloat(paidTodayEl.value) || 0,
        totalDue: parseFloat(totalDueEl.textContent)
      })
    });
    const data = await res.json();
    alert(data.message || "Payment saved successfully");
  } catch (err) {
    console.error(err);
    alert("Failed to save payment");
  }
});

// Initial fetch
fetchPatientTreatments();
</script>

</body>
</html>
